# Monday, February 27, 2023
![banner](https://picsum.photos/seed/2023-February-27/500/200)
> _"A comfort zone is a beautiful place, but nothing ever grows there."_
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**

- [Determining Domains From VPC Flow Logs](#determining-domains-from-vpc-flow-logs)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Determining Domains From VPC Flow Logs

Determine the number of times a domain has been seen in the VPC flow logs.

* This works by using the WhoisXML API to determine the DNS records associated with the IP address, then it uses openssl to determine the domain name from the SSL certificate (if possible).
* This requires a valid API key in https://dns-history.whoisxmlapi.com/

```bash
for ip in $(cat $VPC_FLOW_LOGS_JSON | yq '. | to_entries | map({.key: .value}) | .[][].dstAddr');
  do curl -s https://dns-history.whoisxmlapi.com/api/v1\?apiKey\=$API_KEY\&ip\=$ip
          | yq '.result[0].name'
          | xargs -I {} sh -c "openssl s_client -connect \"{}:443\" 2>/dev/null </dev/null | openssl x509 -noout -subject 2>/dev/null | sed 's/^subject.*CN=//'"; done
          | sort
          | uniq -c
          | awk '{printf "Occurances: %s | Domain: %s\n", $1, $2}'
          | column -s '|' -t 
```

<!--- TODO: fill me out, if you have time today (above this line)--->
